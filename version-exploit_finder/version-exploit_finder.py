import subprocess


# service_finder_function
def package_version(package_name):
    try:
        command = f"dpkg -l | grep {package_name}"

        result = subprocess.check_output(command, shell=True, universal_newlines=True)
        lines = result.split('\n')
        for line in lines:
            if package_name in line:
                parts = line.split()
                version = parts[2]
                return version
        return "Package not found"

    except subprocess.CalledProcessError as e:
        return f"Error: {e}"

# exploit_finder_function
def exploit_check(service):
    try:
        service_name = service.split()[0]
        service_version = service.split()[1]
        exploit_check_cmd = f"searchsploit {service_version}|grep {service_name}"

        searchsploit_result = subprocess.check_output(exploit_check_cmd, shell=True)
        decoded = searchsploit_result.decode("utf-8")
        # print(decoded)
        return decoded

        # print(searchsploit_result.decode('utf-8'))

    except subprocess.CalledProcessError as e:
        return f"Error: {e}"


if __name__ == "__main__":
    # list_of_all_comman_linux_services

    list = [
        "apache",  # web app service
        "mysql",  # database server
        "postgres",  # databaser server
        "sshd",  # secure shell service
        "apache2"
        "httpd",  # Apache HTTP Server
        "nginx",  # Nginx Web Server
        "smbd",  # Samba File and Print Sharing
        "bind9",  # BIND DNS Server
        "postfix",  # SMTP Email Server
        "dovecot",  # POP3/IMAP Email Retrieval
        "nfs",  # NFS (Network File System)
        "dhcpd",  # DHCP (Dynamic Host Configuration Protocol)
        "proftpd",  # FTP (File Transfer Protocol)
        "snmpd",  # SNMP (Simple Network Management Protocol)
        "ntpd",  # NTP (Network Time Protocol)
        "rsyslog",  # Syslog (System Logging)
        "cron",  # Cron (Scheduled Tasks)
        "cups",  # CUPS (Printing Service)
        "avahi-daemon",  # Avahi (Zeroconf/Bonjour)
        "openvpn",  # OpenVPN (VPN Server)
        "sssd",  # SSSD (System Security Services Daemon)
        "docker",  # Docker (Containerization)
        "cupsd",  # CUPS (Printing Service)
        "nis",  # NIS (Network Information Service)
        "slapd",  # LDAP (Lightweight Directory Access Protocol)
        "squid",  # Squid Proxy Server
    ]
    services = ["apache 2.4"]
    print("___________________")
    print("service - version ")
    print("------------------\n")
    for element in list:
        package_name = element
        version = package_version(package_name)
        if "Error" not in version:
            services.append(package_name + " " + version)
            print(f"{package_name} {version}")

    print("\n_____________________________________")
    print("checking for any potential exploits")
    print("-------------------------------------\n")
    for service in services:
        service_name = service.split()[0]
        service_version = service.split()[1]
        searchsploit_result = exploit_check(service)

        if "Error" not in searchsploit_result:
            print(f"exploit found {searchsploit_result}")


